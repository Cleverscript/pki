#!/bin/sh
# postinst script for ovpn
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package


case "$1" in
    configure)
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)

        # Configure firewall
        sudo ufw status
        if [ $? == 0 ]; then
            firewall-rules create allow-1194 --allow=udp:1194 --direction=INGRESS
        fi

        # allow traffic routing
        echo net.ipv4.ip_forward=1 >> /etc/sysctl.conf

        # set name network interface
        ETH=$(ip r | grep default | awk '/'dev'/ {print $5}')
        if [ -z $ETH ]; then
            echo "Error - fail get name network interface!"
            read -p "Please enter name network interface: " ETH
        fi

        # set name transport protocol
        read -p "Please enter protocol [default udp]: " PROTO
        if [ -z $PROTO ]; then
            PROTO=udp
        fi

        # set port
        read -p "Please enter protocol [default 1194]: " PORT
        if [ -z $PORT ]; then
            PORT=1194
        fi

        # OpenVPN
        iptables -A INPUT -i "$ETH" -m state --state NEW -p "$PROTO" --dport "$PORT" -j ACCEPT
        # Allow TUN interface connection to OpenVPN server
        iptables -A INPUT -i tun+ -j ACCEPT
        # Allow TUN interface connection to be forwarded throuth other interface
        iptables -A FORWARD -i tun+ -j ACCEPT
        iptables -A FORWARD -i tun+ -o "$ETH" -m state --state RELATED,ESTABLISHED -j ACCEPT
        iptables -A FORWARD -i "$ETH" -o tun+ -m state --state RELATED,ESTABLISHED -j ACCEPT
        # NAT the VPN client traffic to the internet
        iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o "$ETH" -j MASQUERADE

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
